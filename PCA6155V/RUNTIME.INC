; CONSTANTS
CR      EQU 13  ; CARRIAGE RETURN
LF      EQU 10  ; LINE FEED
PSPENV  EQU 2CH ; PSP ENVIRONMENT BLOCK
DST     EQU 36  ; $ TERMINATOR
ZST     EQU 0   ; 0 TERMINATOR

; STRINGS
INTRO   DB "ADVANTECH PCA-6155V WATCHDOG DRIVER - V0.1 AUG 14 2020",CR,LF,DST
OUTRO   DB "INSTALLING TSR...",CR,LF,CR,LF,DST

; RUNTIME INCLUDES
INCLUDE DOSVER.INC
INCLUDE CMDLINE.INC
INCLUDE LOCKFILE.INC

MAIN:
; PRINT THE INTRO STRING
    MOV DX,OFFSET INTRO
    MOV AH,09H
    INT 21H

    CALL DOSVER
    CALL CMDLINE
    CALL LOCKFILE

GOTSR:
; PRINT THE OUTRO STRING
    MOV DX,OFFSET OUTRO
    MOV AH,09H
    INT 21H

; GET VECTOR OF INT 08H, STORE
    CLI

    MOV AX,3508H
    INT 21H

    MOV WORD PTR DS:OLDVEC+2,ES
    MOV WORD PTR DS:OLDVEC,BX

; SET VECTOR OF INT 08H TO TICKWD
    MOV DX,OFFSET TICKWD
    MOV AX,2508H
    INT 21H

    STI

; FREE ENVIRONMENT FROM PSP
    MOV ES,CS:PSPENV    ; SEGMENT ADDRESS OF ENVIRONMENT BLOCK
    MOV AH,49H
    INT 21H

; DETERMINE MEMORY TO KEEP THEN GO RESIDENT
    MOV DX,OFFSET ENDTSRCODE    ; END OF CODE
    SUB DX,OFFSET ENTRY         ; BEGINNING OF CODE
    ADD DX,100H                 ; PSP SEGMENT
    ADD DX,0FH                  ; PADDING FOR DIVISION
    SHR DX,04H                  ; DIVIDE BY 16

    MOV AX,3100H
    INT 21H
